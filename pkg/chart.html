<html>
<head>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  <script type="text/javascript">
    const chartData = {{.}};

    let selectedCommitIndex = -1;
    let selectedFilterIndex = -1;
    let selectedRank = -1;

    function drawRegionsMap() {
      if (selectedCommitIndex === -1 || selectedFilterIndex === -1) {
        return;
      }

      const options = {
        region: 'JP',
        displayMode: 'regions',
        backgroundColor: '#ebf7fe',
        resolution: 'provinces',
        colors:[
          '#ff0000',
          '#ff8000',
          '#ffff00',
          '#00ff00',
          '#00ffff',
          '#0000ff',
          '#8000ff',
        ],
      };

      const lineCount = chartData.commits[selectedCommitIndex].lineCounts[selectedFilterIndex];

      const dataTable = new google.visualization.DataTable();
      dataTable.addColumn('string', 'Area');
      dataTable.addColumn('number', 'Rank');

      const rows = lineCount.areas.map((area) => {
        return [
          area.name,
          area.authorRank,
        ]});
      dataTable.addRows(rows);

      const chart = new google.visualization.GeoChart(document.getElementById('regions_div'));
      chart.draw(dataTable, options);
      google.visualization.events.addListener(chart, 'select', () => {
        const selection = chart.getSelection()[0];
        if (selection) {
          selectedRank = selection.row;
        } else {
          selectedRank = -1;
        }
      });

      updateRanking();
    }

    function updateRanking() {
      if (selectedCommitIndex === -1 || selectedFilterIndex === -1) {
        return;
      }

      const rankingEl = document.getElementById("ranking");
      rankingEl.innerHTML = '<tr><th>#</th><th>Author</th><th>Lines</th></tr>';

      const lineCount = chartData.commits[selectedCommitIndex].lineCounts[selectedFilterIndex];
      console.log(lineCount);
      for (const [i, author] of lineCount.authors.entries()) {
        let authorName = author.email;
        if (author.gitHubLogin) {
          authorName = author.gitHubLogin;
        } else if (author.name) {
          authorName = author.name;
        }
        const values = [
          i+1,
          authorName,
          author.lineCount.toLocaleString(),
        ];

        const trEl = document.createElement("tr");
        for (const value of values) {
          const tdEl = document.createElement("td");
          tdEl.innerText = value;
          trEl.append(tdEl);
        }
        rankingEl.append(trEl);
      }
    }

    function updateFilter() {
      const filterEl = document.getElementById("filter");
      filterEl.innerHTML = '';

      const commit = chartData.commits[selectedCommitIndex];
      for (const lineCount of commit.lineCounts) {
        const optEl = document.createElement("option");
        optEl.innerText = lineCount.filterRegex;
        optEl.onchange = () => {
          selectedFilterIndex = filterEl.selectedIndex;
          selectedRank = -1;
          drawRegionsMap();
        };
        filterEl.append(optEl);
      }
    }

    google.charts.load('current', {
      'packages':['geochart'],
    });
    window.onresize = drawRegionsMap;
    window.onload = () => {
      const shortHash = (value) => value.substring(0, 7);

      document.getElementById("repository").innerText = chartData.repository;
      document.getElementById("generated").innerText = new Date(chartData.generatedAt).toLocaleString();

      const commitEl = document.getElementById("commit");
      for (const commit of chartData.commits) {
        const optEl = document.createElement("option");
        optEl.innerText = `${new Date(commit.committedAt).toLocaleString()} ${shortHash(commit.hash)}`;
        commitEl.append(optEl);
      }

      commitEl.onchange = () => {
        selectedCommitIndex = commitEl.selectedIndex;
        selectedRank = -1;
        drawRegionsMap();
      };

      if (chartData.commits.length > 0) {
        selectedCommitIndex = 0;
        selectedFilterIndex = 0;
        selectedRank = -1;
        updateFilter();
      }

      drawRegionsMap();
    };
  </script>
  <title>Kunitori</title>
  <style>
    #ranking div.selected {
      color: gold;
    }
  </style>
</head>
<body>
<div id="regions_div" style="width: 100%; height: 100%;"></div>
<div style="position: fixed; right: 0; top: 0; margin: 1em; padding: 1em; background-color: white; max-height: 60vh; overflow-y: auto;">
  <table id="ranking">
  </table>
</div>
<div style="position: fixed; right: 0; bottom: 0; margin: 1em; padding: 1em; background-color: white; max-height: 20vh; overflow-y: auto;">
  <table>
    <tr>
      <td>Repository</td>
      <td><span id="repository"></span></td>
    </tr>
    <tr>
      <td>Generated</td>
      <td><span id="generated"></span></td>
    </tr>
    <tr>
      <td>Commit</td>
      <td><select id="commit"></select></td>
    </tr>
    <tr>
      <td>Filter</td>
      <td><select id="filter"></select></td>
    </tr>
  </table>
</div>
</body>
</html>
